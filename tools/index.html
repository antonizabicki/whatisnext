<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tools | what-is-next</title>
    
    <!-- GSAP Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollTrigger.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/ScrollToPlugin.min.js"></script>

    <style>
        /* --- RESET I BAZA --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        html { scroll-behavior: smooth; }
        body {
            background-color: #050505;
            color: #ffffff;
            overflow-x: hidden;
            position: relative;
        }

        /* --- TŁO (BACKGROUND FX) --- */
        .ambient-background {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; z-index: -1;
            overflow: hidden; background: #050505; pointer-events: none;
        }
        .blob {
            position: absolute; border-radius: 50%; filter: blur(100px); opacity: 0.08;
            animation: float 20s infinite alternate ease-in-out;
        }
        .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: white; animation-duration: 25s; }
        .blob-2 { bottom: -10%; right: -10%; width: 60vw; height: 60vw; background: #444; animation-duration: 30s; animation-direction: alternate-reverse; }
        .blob-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: #222; opacity: 0.12; filter: blur(80px); animation-name: float-center; animation-duration: 35s; }

        @keyframes float { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(50px, 80px) scale(1.1); } }
        @keyframes float-center { 0% { transform: translate(-100px, -50px) rotate(0deg); } 100% { transform: translate(100px, 50px) rotate(20deg); } }

        section, header, footer { scroll-margin-top: 120px; }

        /* --- MENU BAR --- */
        .glass-menu-container {
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 100;
            width: 90%; max-width: 600px;
        }
        .glass-menu {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.6rem 1.5rem; background: rgba(20, 20, 20, 0.65);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 9999px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .menu-left, .menu-right { display: flex; align-items: center; gap: 2rem; }
        .menu-link { color: #aaa; text-decoration: none; font-size: 0.9rem; font-weight: 500; transition: color 0.3s ease; }
        .menu-link:hover { color: white; }

        /* --- HEADER & TYPO --- */
        header { text-align: center; padding: 8rem 2rem 2rem 2rem; position: relative; z-index: 10; }
        h1 {
            font-size: clamp(3rem, 7vw, 6rem); line-height: 1.1; font-weight: 700; letter-spacing: -0.02em;
            background: linear-gradient(to bottom, #ffffff, #888888); -webkit-background-clip: text; -webkit-text-fill-color: transparent; margin-bottom: 1rem;
            text-transform: uppercase;
        }
        h2 { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.3em; color: #888; margin-bottom: 1.5rem; font-weight: 500; }
        p { color: #a1a1a1; line-height: 1.5; font-size: 1.1rem; max-width: 600px; margin: 0 auto; }

        /* --- TOOLS CONTAINER --- */
        .tools-section {
            max-width: 900px; margin: 0 auto; padding: 0 2rem 4rem 2rem;
            display: flex; flex-direction: column; gap: 4rem;
        }

        /* --- COMMON CONTAINER STYLE --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.02);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 2rem;
            text-align: center;
            opacity: 1;
            transition: opacity 0.3s;
        }
        .section-label {
            margin-bottom: 0.5rem; color: #666; font-size: 0.8rem; letter-spacing: 2px; text-transform: uppercase; display: block;
        }

        /* --- PITCH CALCULATOR --- */
        .result-display { margin-bottom: 1.5rem; }
        .semitone-count { font-size: 4rem; font-weight: 800; line-height: 1; display: block; margin-bottom: 0.5rem; }
        .result-text { font-size: 0.9rem; text-transform: uppercase; letter-spacing: 2px; color: #888; }
        .highlight { color: #fff; font-weight: bold; }

        /* Piano UI Common */
        .piano-wrapper { display: inline-block; position: relative; margin: 1.5rem 0; user-select: none; }
        .piano-keys { display: flex; position: relative; justify-content: center; }
        .key {
            width: 35px; height: 120px; background: #e0e0e0; border: 1px solid #000;
            border-radius: 0 0 4px 4px; cursor: pointer; transition: background 0.1s;
            position: relative; z-index: 1;
        }
        .key:active { background: #ccc; }
        .key.black {
            width: 24px; height: 75px; background: #111; position: absolute; top: 0; z-index: 2;
            border-radius: 0 0 4px 4px; border: 1px solid #000;
        }
        .key.active-root { background: #4CAF50 !important; box-shadow: 0 0 15px rgba(76, 175, 80, 0.5); }
        .key.black.active-root { background: #2E7D32 !important; }

        .controls-row { display: flex; align-items: center; justify-content: center; gap: 2rem; margin-top: 1rem; }
        .adjust-btn {
            background: rgba(255,255,255,0.1); border: none; color: white;
            width: 30px; height: 30px; border-radius: 50%; font-size: 1.2rem;
            cursor: pointer; transition: background 0.2s; display: flex; align-items: center; justify-content: center;
        }
        .adjust-btn:hover { background: rgba(255,255,255,0.2); }
        .switch-container { display: flex; align-items: center; gap: 10px; font-weight: 600; font-size: 0.8rem; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4CAF50; }
        input:checked + .slider:before { transform: translateX(24px); }

        /* --- FREQUENCY CHART STYLES --- */
        .freq-table-container {
            margin-top: 2rem;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(80px, 1fr));
            gap: 10px;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        .freq-box {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 10px 5px;
            display: flex;
            flex-direction: column;
            align-items: center;
            border: 1px solid rgba(255,255,255,0.05);
        }
        .freq-octave { font-size: 0.75rem; color: #888; text-transform: uppercase; margin-bottom: 4px; }
        .freq-value { font-size: 1rem; font-weight: 700; color: #fff; }
        .freq-hz-label { font-size: 0.7rem; color: #4CAF50; }

        /* --- DELAY CALCULATOR STYLES --- */
        .delay-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(60px, 1fr));
            gap: 8px;
            margin-bottom: 1.5rem;
            max-width: 800px;
            margin-left: auto;
            margin-right: auto;
        }
        .delay-btn {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            color: #aaa;
            padding: 10px 0;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }
        .delay-btn:hover { background: rgba(255,255,255,0.15); color: white; }
        .delay-btn.active { background: #4CAF50; color: black; font-weight: bold; border-color: #4CAF50; }

        .delay-options { display: flex; justify-content: center; gap: 20px; margin-bottom: 2rem; }
        .radio-label { display: flex; align-items: center; gap: 6px; cursor: pointer; color: #ccc; font-size: 0.9rem; }
        .radio-label input { accent-color: #4CAF50; }

        .ableton-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 6px;
            margin-bottom: 1.5rem;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        @media (max-width: 600px) {
            .ableton-grid { grid-template-columns: repeat(4, 1fr); }
        }

        .bpm-input-container { margin: 2rem 0; }
        .bpm-input {
            background: transparent; border: none; border-bottom: 2px solid #333;
            color: white; font-size: 2rem; text-align: center; width: 120px;
            font-weight: bold; padding-bottom: 5px; outline: none; transition: border-color 0.3s;
        }
        .bpm-input:focus { border-color: #4CAF50; }
        .bpm-label { font-size: 0.8rem; color: #666; display: block; margin-top: 5px; }

        .delay-result {
            background: rgba(0,0,0,0.3);
            border-radius: 12px;
            padding: 1.5rem;
            display: inline-flex;
            gap: 3rem;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .d-res-box h5 { color: #666; font-size: 0.7rem; margin-bottom: 5px; letter-spacing: 1px; }
        .d-res-box span { font-size: 1.8rem; font-weight: bold; color: white; }
        .d-res-unit { font-size: 1rem; color: #4CAF50; margin-left: 2px; }


        /* --- TUNEBAT SEARCH (KEY FINDER) --- */
        .tunebat-section {
            display: flex; 
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            background: rgba(20, 20, 20, 0.6); 
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 20px; 
            padding: 4rem;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }
        
        .search-title { font-size: 1.8rem; margin-bottom: 0.3rem; font-weight: 600; color: white; text-transform: uppercase; }
        .search-desc { font-size: 0.9rem; margin-bottom: 3rem; color: #666; text-transform: uppercase; letter-spacing: 1px; }
        
        .tunebat-form { width: 100%; max-width: 600px; }
        
        .input-group { 
            position: relative; width: 100%; display: flex; align-items: center; 
            border-bottom: 1px solid rgba(255,255,255,0.15); padding-bottom: 5px; transition: border-color 0.3s;
        }
        .input-group:focus-within { border-bottom-color: rgba(255,255,255,0.6); }

        .search-input {
            flex-grow: 1; background: transparent; border: none; color: white; 
            font-size: 1.4rem; padding: 10px 0; outline: none; font-weight: 500;
            text-transform: uppercase; text-align: left;
        }
        .search-input::placeholder { color: #444; }

        .search-btn {
            background: white; border: none; width: 50px; height: 50px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: transform 0.2s, background 0.2s; margin-left: 15px; flex-shrink: 0;
        }
        .search-btn:hover { background: #eee; transform: scale(1.05); }
        .search-btn svg { width: 20px; height: 20px; stroke: black; stroke-width: 2.5; }

        @media (max-width: 768px) {
            .tunebat-section { padding: 2rem; }
            .search-input { font-size: 1rem; }
            .search-btn { width: 40px; height: 40px; }
            .delay-result { flex-direction: column; gap: 1rem; }
        }

        /* --- CIRCLE IMAGE SECTION --- */
        .circle-section {
            width: 100%; display: flex; justify-content: center; padding: 2rem 2rem 6rem 2rem;
        }
        .circle-image-wrapper {
            max-width: 600px; width: 100%; opacity: 0.7; transition: opacity 0.5s;
        }
        .circle-image-wrapper:hover { opacity: 1; }
        .circle-image-wrapper img {
            width: 100%; height: auto; display: block;
            filter: drop-shadow(0 0 30px rgba(0,0,0,0.3));
        }

        /* --- FOOTER --- */
        footer { text-align: center; padding: 2rem; border-top: 1px solid rgba(255,255,255,0.05); background: #050505; position: relative; z-index: 20; }
        .anim-up { opacity: 0; transform: translateY(30px); }
    </style>
</head>
<body>

    <!-- ANIMATED BACKGROUND -->
    <div class="ambient-background">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
    </div>

    <!-- MENU BAR -->
    <div class="glass-menu-container">
        <nav class="glass-menu">
            <div class="menu-left">
                <a href="https://what-is-next.vip/creative" class="menu-link">Home</a>
                <a href="#keyfinder" class="menu-link">Studio Tools</a>
            </div>
            <div class="menu-right">
                <a href="mailto:demo@what-is-next.vip" class="menu-link">Contact</a>
            </div>
        </nav>
    </div>

    <!-- HEADER -->
    <header id="top">
        <div class="header-content">
            <h2 class="anim-up">what-is-next creative</h2>
            <h1 class="anim-up">Studio Tools</h1>
            <p class="anim-up">Simple tools to accelerate your workflow.</p>
        </div>
    </header>

    <!-- TOOLS SECTION -->
    <section class="tools-section">

        <!-- 1. PITCH CALCULATOR -->
        <div id="pitcher" class="glass-panel anim-fade">
            <span class="section-label">PITCH CALCULATOR</span>
            <div class="result-display">
                <span class="semitone-count" id="semitoneDisplay">0</span>
                <span class="result-text">SEMITONES FROM <span id="startNoteDisplay" class="highlight">C</span> TO <span id="targetNoteDisplay" class="highlight">C</span></span>
            </div>

            <!-- Piano Interface -->
            <div class="piano-wrapper">
                <div class="piano-keys" id="pianoPitch"></div>
            </div>

            <!-- Controls -->
            <div class="controls-row">
                <div style="text-align:center">
                    <div style="display:flex; gap:10px; align-items:center;">
                        <button class="adjust-btn" onclick="adjustTarget(-1)">-</button>
                        <button class="adjust-btn" onclick="adjustTarget(1)">+</button>
                    </div>
                </div>
                <div class="switch-container">
                    <span id="goUpLabel" style="color: #4CAF50;">UP</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="directionSwitch" onchange="calculatePitch()">
                        <span class="slider"></span>
                    </label>
                    <span id="goDownLabel" style="color: #666;">DOWN</span>
                </div>
            </div>
        </div>

        <!-- 2. FREQUENCY CHART (NOWA SEKCJA) -->
        <div id="freqChart" class="glass-panel anim-fade">
            <span class="section-label">NOTE FREQUENCIES (HZ)</span>
            <p style="font-size: 0.9rem; color: #888; margin-bottom: 1rem;">Select a root note to see frequencies across octaves.</p>

            <!-- Piano Interface for Frequency -->
            <div class="piano-wrapper">
                <div class="piano-keys" id="pianoFreq"></div>
            </div>

            <div class="result-text" style="margin-top: 1rem;">SELECTED: <span id="freqNoteName" class="highlight">C</span></div>

            <div class="freq-table-container" id="freqTable">
                <!-- Javascript wygeneruje tutaj kafelki -->
            </div>
        </div>

        <!-- 3. DELAY CALCULATOR (NOWA SEKCJA) -->
        <div id="delayCalc" class="glass-panel anim-fade">
            <span class="section-label">DELAY & HERTZ CALCULATOR</span>
            
            <div class="bpm-input-container">
                <input type="number" id="bpmInput" class="bpm-input" value="120" oninput="updateDelayCalc()">
                <span class="bpm-label">BPM</span>
            </div>

            <!-- Standard Notes -->
            <h4 style="font-size: 0.8rem; color: #888; margin-bottom: 10px; margin-top:20px;">STANDARD NOTES</h4>
            <div class="delay-options">
                <label class="radio-label"><input type="radio" name="noteMod" value="1" checked onchange="updateDelayCalc()"> Normal</label>
                <label class="radio-label"><input type="radio" name="noteMod" value="1.5" onchange="updateDelayCalc()"> Dotted</label>
                <label class="radio-label"><input type="radio" name="noteMod" value="0.666666" onchange="updateDelayCalc()"> Triplets</label>
            </div>
            
            <div class="delay-grid">
                <button class="delay-btn" onclick="setNoteFraction(1, this)">1/1</button>
                <button class="delay-btn" onclick="setNoteFraction(0.5, this)">1/2</button>
                <button class="delay-btn active" onclick="setNoteFraction(0.25, this)">1/4</button>
                <button class="delay-btn" onclick="setNoteFraction(0.125, this)">1/8</button>
                <button class="delay-btn" onclick="setNoteFraction(0.0625, this)">1/16</button>
                <button class="delay-btn" onclick="setNoteFraction(0.03125, this)">1/32</button>
                <button class="delay-btn" onclick="setNoteFraction(0.015625, this)">1/64</button>
                <button class="delay-btn" onclick="setNoteFraction(0.0078125, this)">1/128</button>
            </div>

            <!-- Ableton Mode -->
            <h4 style="font-size: 0.8rem; color: #888; margin-bottom: 10px; margin-top: 30px;">ABLETON DELAY NUMBERS</h4>
            <div class="ableton-grid" id="abletonGrid">
                <!-- Generated by JS -->
            </div>

            <!-- Result -->
            <div class="delay-result" style="margin-top: 2rem;">
                <div class="d-res-box">
                    <h5>TIME</h5>
                    <span id="resMs">500</span><span class="d-res-unit">ms</span>
                </div>
                <div class="d-res-box">
                    <h5>FREQUENCY</h5>
                    <span id="resHz">2.00</span><span class="d-res-unit">Hz</span>
                </div>
            </div>
        </div>

        <!-- 4. KEY FINDER (TUNEBAT) -->
        <div id="keyfinder" class="tunebat-section anim-fade">
            <h3 class="search-title">Find Key of Any Song</h3>
            <p class="search-desc">(USING TUNEBAT)</p>
            
            <form id="tunebatForm" class="tunebat-form" onsubmit="searchTunebat(event)">
                <div class="input-group">
                    <input type="text" id="songInput" class="search-input" placeholder="ENTER ARTIST AND TITLE..." autocomplete="off">
                    <button type="submit" class="search-btn">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>
                    </button>
                </div>
            </form>
        </div>

    </section>

    <!-- 5. CIRCLE IMAGE SECTION -->
    <section class="circle-section anim-fade">
        <div class="circle-image-wrapper">
            <img src="circle.png" alt="Camelot Wheel" onerror="this.src='https://mixedinkey.com/wp-content/uploads/2020/09/Camelot-Wheel-1024x1024.png'">
        </div>
    </section>

    <!-- FOOTER -->
    <footer>
        <p style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 2px; color: #444;">© 2025 what-is-next™</p>
    </footer>

    <!-- LOGIKA JS -->
    <script>
        gsap.registerPlugin(ScrollTrigger);

        // --- ANIMATIONS ---
        gsap.to(".anim-up", {
            y: 0, opacity: 1, duration: 1.2, stagger: 0.2, ease: "power3.out"
        });

        const fadeItems = document.querySelectorAll(".anim-fade");
        fadeItems.forEach(item => {
            gsap.from(item, {
                scrollTrigger: { trigger: item, start: "top 90%" },
                y: 30, opacity: 0, duration: 0.8, ease: "power2.out"
            });
        });

        // --- GLOBAL DATA ---
        const notes = ['C', 'C#', 'D', 'Eb', 'E', 'F', 'F#', 'G', 'G#', 'A', 'Bb', 'B'];
        // Klawisze piano UI definition
        const keyMap = [
            { note: 'C', type: 'white', idx: 0 },
            { note: 'C#', type: 'black', idx: 1, left: 24 },
            { note: 'D', type: 'white', idx: 2 },
            { note: 'Eb', type: 'black', idx: 3, left: 59 },
            { note: 'E', type: 'white', idx: 4 },
            { note: 'F', type: 'white', idx: 5 },
            { note: 'F#', type: 'black', idx: 6, left: 129 },
            { note: 'G', type: 'white', idx: 7 },
            { note: 'G#', type: 'black', idx: 8, left: 164 },
            { note: 'A', type: 'white', idx: 9 },
            { note: 'Bb', type: 'black', idx: 10, left: 199 },
            { note: 'B', type: 'white', idx: 11 }
        ];

        // --- 1. PITCH CALCULATOR LOGIC ---
        let pStartIndex = 0; 
        let pTargetIndex = 0; 

        function renderPitchPiano() {
            const container = document.getElementById('pianoPitch');
            container.innerHTML = '';
            
            // White keys
            keyMap.filter(k => k.type === 'white').forEach(k => {
                const el = document.createElement('div');
                el.className = `key ${pStartIndex === k.idx ? 'active-root' : ''}`;
                el.onclick = () => setPitchStart(k.idx);
                container.appendChild(el);
            });
            // Black keys
            keyMap.filter(k => k.type === 'black').forEach(k => {
                const el = document.createElement('div');
                el.className = `key black ${pStartIndex === k.idx ? 'active-root' : ''}`;
                el.style.left = k.left + 'px';
                el.onclick = () => setPitchStart(k.idx);
                container.appendChild(el);
            });
        }

        function setPitchStart(idx) {
            pStartIndex = idx;
            renderPitchPiano();
            calculatePitch();
        }

        function adjustTarget(amount) {
            pTargetIndex = (pTargetIndex + amount);
            if (pTargetIndex < 0) pTargetIndex = 11;
            if (pTargetIndex > 11) pTargetIndex = 0;
            calculatePitch();
        }

        function calculatePitch() {
            const isDown = document.getElementById('directionSwitch').checked;
            document.getElementById('goUpLabel').style.color = isDown ? '#666' : '#4CAF50';
            document.getElementById('goDownLabel').style.color = isDown ? '#4CAF50' : '#666';

            let diff;
            if (!isDown) {
                if (pTargetIndex >= pStartIndex) diff = pTargetIndex - pStartIndex;
                else diff = 12 - (pStartIndex - pTargetIndex);
            } else {
                if (pTargetIndex <= pStartIndex) diff = pStartIndex - pTargetIndex; // Fixed logic here
                else diff = 12 - (pTargetIndex - pStartIndex);
            }

            document.getElementById('semitoneDisplay').innerText = diff;
            document.getElementById('startNoteDisplay').innerText = notes[pStartIndex];
            document.getElementById('targetNoteDisplay').innerText = notes[pTargetIndex];
        }

        // --- 2. FREQUENCY CHART LOGIC ---
        let fSelectedIndex = 9; // Default to A (A4=440)
        
        // Base frequencies for Octave 0 (Approximate correct data)
        // C0 to B0 based on A4=440Hz -> A0=27.5Hz
        // Formula: f = 440 * 2^((n-49)/12) where n is key number (A4 is 49th key)
        // Ale użyjemy hardcoded bazowego C0 i mnożników dla uproszczenia zgodnego ze zdjęciem.
        // C0 ~ 16.35
        const baseFreqsC0 = [
            16.35, // C
            17.32, // C#
            18.35, // D
            19.45, // Eb
            20.60, // E
            21.83, // F
            23.12, // F#
            24.50, // G
            25.96, // G#
            27.50, // A
            29.14, // Bb
            30.87  // B
        ];

        function renderFreqPiano() {
            const container = document.getElementById('pianoFreq');
            container.innerHTML = '';
            
            keyMap.filter(k => k.type === 'white').forEach(k => {
                const el = document.createElement('div');
                el.className = `key ${fSelectedIndex === k.idx ? 'active-root' : ''}`;
                el.onclick = () => showFreqs(k.idx);
                container.appendChild(el);
            });
            keyMap.filter(k => k.type === 'black').forEach(k => {
                const el = document.createElement('div');
                el.className = `key black ${fSelectedIndex === k.idx ? 'active-root' : ''}`;
                el.style.left = k.left + 'px';
                el.onclick = () => showFreqs(k.idx);
                container.appendChild(el);
            });
        }

        function showFreqs(idx) {
            fSelectedIndex = idx;
            document.getElementById('freqNoteName').innerText = notes[idx];
            renderFreqPiano();
            generateFreqTable(idx);
        }

        function generateFreqTable(noteIdx) {
            const container = document.getElementById('freqTable');
            container.innerHTML = '';
            const base = baseFreqsC0[noteIdx];

            for (let oct = 0; oct <= 8; oct++) {
                // Freq = base * 2^octave
                let val = base * Math.pow(2, oct);
                
                // Formatowanie: mniej miejsc po przecinku dla dużych liczb
                let displayVal;
                if (val > 1000) displayVal = Math.round(val);
                else if (val > 100) displayVal = val.toFixed(1);
                else displayVal = val.toFixed(2);

                const div = document.createElement('div');
                div.className = 'freq-box';
                div.innerHTML = `
                    <span class="freq-octave">${notes[noteIdx]}${oct}</span>
                    <span class="freq-value">${displayVal}</span>
                    <span class="freq-hz-label">Hz</span>
                `;
                container.appendChild(div);
            }
        }

        // --- 3. DELAY CALCULATOR LOGIC ---
        let currentBpm = 120;
        let currentNoteFraction = 0.25; // 1/4 note default
        let isAbletonMode = false;
        let currentAbletonNum = 4; // default to 4 (1/4 note)

        function initDelayCalc() {
            // Generate Ableton Buttons (1-16)
            const abGrid = document.getElementById('abletonGrid');
            for(let i=1; i<=16; i++) {
                const btn = document.createElement('button');
                btn.className = 'delay-btn';
                btn.innerText = i;
                btn.onclick = () => setAbletonNumber(i, btn);
                if(i===4) btn.classList.add('inactive'); // Just styling hook if needed
                abGrid.appendChild(btn);
            }
            updateDelayCalc();
        }

        function setNoteFraction(frac, btn) {
            isAbletonMode = false;
            currentNoteFraction = frac;
            
            // UI Update
            document.querySelectorAll('.delay-grid .delay-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.ableton-grid .delay-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');

            updateDelayCalc();
        }

        function setAbletonNumber(num, btn) {
            isAbletonMode = true;
            currentAbletonNum = num;

            // UI Update
            document.querySelectorAll('.delay-grid .delay-btn').forEach(b => b.classList.remove('active'));
            document.querySelectorAll('.ableton-grid .delay-btn').forEach(b => b.classList.remove('active'));
            if(btn) btn.classList.add('active');

            updateDelayCalc();
        }

        function updateDelayCalc() {
            const bpm = parseFloat(document.getElementById('bpmInput').value) || 120;
            let ms = 0;

            if (isAbletonMode) {
                // Ableton "1" = one 16th note.
                // 1 Beat (1/4 note) in ms = 60000 / BPM
                // 16th note = (60000 / BPM) / 4
                // Delay = Number * 16th_note_ms
                const oneSixteenth = (60000 / bpm) / 4;
                ms = currentAbletonNum * oneSixteenth;
            } else {
                // Standard Note Mode
                // Base: 1/1 (Whole note) = (60000 / BPM) * 4
                const wholeNoteMs = (60000 / bpm) * 4;
                let baseMs = wholeNoteMs * currentNoteFraction;

                // Modifiers
                const mod = document.querySelector('input[name="noteMod"]:checked').value;
                ms = baseMs * parseFloat(mod);
            }

            // Calculate Hz (f = 1000 / T_ms)
            let hz = 0;
            if (ms > 0) hz = 1000 / ms;

            document.getElementById('resMs').innerText = ms.toFixed(2);
            document.getElementById('resHz').innerText = hz.toFixed(2);
        }


        // --- TUNEBAT SEARCH LOGIC ---
        function searchTunebat(e) {
            e.preventDefault();
            const query = document.getElementById('songInput').value.trim();
            const baseUrl = "https://tunebat.com/Search?q=";
            if(query) {
                window.open(baseUrl + encodeURIComponent(query), '_blank');
            } else {
                window.open(baseUrl, '_blank');
            }
        }

        // --- INIT ALL ---
        renderPitchPiano();
        calculatePitch();
        showFreqs(0); // Init C frequencies
        initDelayCalc();

    </script>
</body>
</html>
